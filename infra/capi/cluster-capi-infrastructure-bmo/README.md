# cluster-capi-infrastructure-bmo

## Description

Bare metal operator provider package

## build

```
git clone https://github.com/metal3-io/baremetal-operator.git
cd baremetal-operator
kustomize build config/default > cluster-api-infrastructure-bmo.yaml
```

## Adding image tags
The yaml generated by the above step does not add an image tag and uses the default `latest` for the tag, hence, follow below steps to add image tag.

1. Get the released version of a image tag by looking up https://quay.io/repository/metal3-io/baremetal-operator?tab=tags
2. Next, create a directory such as `/tmp/bmokpt` and copy the above generated `cluster-api-infrastructure-bmo.yaml` file to this directory.
3. ```bash
   cd /tmp/bmokpt
   kpt pkg init
   ```
4. Edit the `Kptfile` to add the below contents
   ```bash
   pipeline:
     mutators:
     - image: gcr.io/kpt-fn/set-image:v0.1.1
       configMap:
         name: quay.io/metal3-io/baremetal-operator
         newTag: v0.9.1
   ```
5.  The new `Kptfile` contents would look similar to below
   ```bash
apiVersion: kpt.dev/v1
kind: Kptfile
metadata:
  name: bmo
  annotations:
    config.kubernetes.io/local-config: "true"
pipeline:
  mutators:
  - image: gcr.io/kpt-fn/set-image:v0.1.1
    configMap:
      name: quay.io/metal3-io/baremetal-operator
      newTag: v0.9.1
info:
  description: cluster-api bare metal operator provider package
   ```
6. Next, execute the `kpt fn render` to apply the mutators in the pipeline that will set the image tag,
```bash
/tmp/bmokpt$ kpt fn render
Package "bmokpt":
[RUNNING] "gcr.io/kpt-fn/set-image:v0.1.1"
[PASS] "gcr.io/kpt-fn/set-image:v0.1.1" in 700ms
  Results:
    [info] apps/v1/Deployment/baremetal-operator-system/baremetal-operator-controller-manager spec.template.spec.containers.image: set image from quay.io/metal3-io/baremetal-operator to quay.io/metal3-io/baremetal-operator:v0.9.1

Successfully executed 1 function(s) in 1 package(s).
```
7. The updated `cluster-api-infrastructure-bmo.yaml` file with image tag set can next be uploaded the catalog repo.